Server Hardening Steps-Ubuntu-16

Run OS Upgrades
•	apt-get update
•	apt-get upgrade
•	From Command Line: 
o	apt-get update && apt-get upgrade
SSHD Client Update To Harden SSH Activities
1.	Update /etc/ssh/sshd_config file as below

a.	Limit idle SSH Sessions
Add this line:
•	ClientAliveCountMax  3
•	From Command Line: 
o	echo -e '#Limit idle SSH Sessions\nClientAliveCountMax  3' >> /etc/ssh/sshd_config

b.	Restricting SSH Access to specific network [We are not applying this until we have an additional SSH strategy]
Add this line:
•	AllowUsers *@10.142.0.* [For Test Network]
•	AllowUsers *@10.242.0.* [For Production Network]
•	From Command Line:
o	echo -e '#Restrict SSH access\nAllowUsers *@10.142.0.*' >> /etc/ssh/sshd_config

c.	Block root login
•	Replace “PermitRootLogin prohibit-password” with “PermitRootLogin no”
•	From Command Line:
o	sed -i 's/PermitRootLogin prohibit-password/PermitRootLogin no/g' /etc/ssh/sshd_config

d.	Restart SSHD Service to update the SSHD changes
•	service sshd restart
Disable SSH Roaming Bug
1.	Update /etc/ssh/ssh_config file as below

a.	Block SSH Vulnerabilities
Add this line:
•	UseRoaming no
•	From Command line: 
o	echo -e 'Host *\n#Disable Roaming\nUseRoaming no' >> /etc/ssh/ssh_config

b.	Restart SSH Service to update SSH changes
•	service ssh restart
Banner Setup	
1.	Update /etc/issue.net file as below
a.	Add SSH login security warning message
Add these lines:
•	Please be cautious about unauthorized access. 
We watch, monitor and trace all the accesses and 
take legal action against any unauthorized access.
•	From Command Line:
o	echo -e ' Please be cautious about unauthorized access.\nWe watch, monitor and trace all the accesses and\ntake legal action against any unauthorized access.' >> /etc/issue.net

2.	Update /etc/ssh/sshd_config as below
a.	Enable custom SSH login security warning message
Uncomment this line:
•	#Banner /etc/issue.net
•	From Command Line:
o	sed -i 's/#Banner/Banner/g' /etc/ssh/sshd_config

b.	Restart SSHD service
•	service sshd restart

3.    Update  /etc/pam.d/sshd file as below
a.	Block default banner message of the day (MOTD)
Comment these lines:
•	session    optional     pam_motd.so  motd=/run/motd.dynamic
•	session    optional     pam_motd.so noupdate
•	From Command Line:
o	sed -i 's/session    optional     pam_motd.so  motd=\/run\/motd.dynamic/#session    optional     pam_motd.so  motd=\/run\/motd.dynamic/g' /etc/pam.d/sshd
o	sed -i 's/session    optional     pam_motd.so noupdate/#session    optional     pam_motd.so noupdate/g' /etc/pam.d/sshd

Network Hardening
1.	Update /etc/sysctl.conf file as below
a.	IP Spoofing protection
Uncomment these lines:
•	#net.ipv4.conf.all.rp_filter=1
•	#net.ipv4.conf.default.rp_filter=1
•	From Command Line:
o	sed -i 's/#net.ipv4.conf.all.rp_filter/net.ipv4.conf.all.rp_filter/g' /etc/sysctl.conf
o	sed -i 's/#net.ipv4.conf.default.rp_filter/net.ipv4.conf.default.rp_filter/g' /etc/sysctl.conf

b.	Disable source packet routing
Uncomment these lines:
•	#net.ipv4.conf.all.accept_source_route = 0
•	#net.ipv6.conf.all.accept_source_route = 0
•	From Command Line:
o	sed -i 's/#net.ipv4.conf.all.accept_source_route/ net.ipv4.conf.all.accept_source_route/g' /etc/sysctl.conf
o	sed -i 's/#net.ipv6.conf.all.accept_source_route/ net.ipv6.conf.all.accept_source_route/g' /etc/sysctl.conf

c.	Ignore send ICMP redirects
Uncomment these lines:
•	#net.ipv4.conf.all.send_redirects = 0
•	From Command Line:
o	sed -i 's/#net.ipv4.conf.all.send_redirects/net.ipv4.conf.all.send_redirects/g' /etc/sysctl.conf

d.	Ignore accept ICMP redirects
Uncomment these lines:
•	#net.ipv4.conf.all.accept_redirects = 0
•	#net.ipv6.conf.all.accept_redirects = 0
•	From Command Line:
o	sed -i 's/#net.ipv4.conf.all.accept_redirects/net.ipv4.conf.all.accept_redirects/g' /etc/sysctl.conf
o	sed -i 's/#net.ipv6.conf.all.accept_redirects/net.ipv6.conf.all.accept_redirects/g' /etc/sysctl.conf

e.	Block SYN attacks
Uncomment this line:
•	#net.ipv4.tcp_syncookies=1
•	From Command Line:
o	sed -i 's/#net.ipv4.tcp_syncookies/net.ipv4.tcp_syncookies/g' /etc/sysctl.conf

f.	Log Martians
Uncomment this line:
•	#net.ipv4.conf.all.log_martians = 1
•	From Command Line:
o	sed -i 's/#net.ipv4.conf.all.log_martians/net.ipv4.conf.all.log_martians /g' /etc/sysctl.conf


g.	Ignore ICMP broadcast requests
Add these lines:
•	# Ignore ICMP broadcast requests
•	net.ipv4.icmp_echo_ignore_broadcasts = 1
•	From Command Line:
o	echo -e '# Ignore ICMP broadcast requests\nnet.ipv4.icmp_echo_ignore_broadcasts = 1' >> /etc/sysctl.conf

h.	Disable source packet routing
Add these lines:
•	net.ipv4.conf.default.accept_source_route = 0
•	net.ipv6.conf.default.accept_source_route = 0
•	From Command Line:
o	sed -i '/net.ipv4.conf.all.accept_source_route/anet.ipv4.conf.default.accept_source_route = 0' /etc/sysctl.conf
o	sed -i '/net.ipv6.conf.all.accept_source_route/anet.ipv6.conf.default.accept_source_route = 0' /etc/sysctl.conf

i.	Ignore send ICMP redirects
Add this line:
•	net.ipv4.conf.default.send_redirects = 0
•	From Command Line:
o	sed -i '/net.ipv4.conf.all.send_redirects = 0/anet.ipv4.conf.default.send_redirects = 0' /etc/sysctl.conf

j.	Ignore accept ICMP redirects
Add these lines:
•	net.ipv4.conf.default.accept_redirects = 0 
•	net.ipv6.conf.default.accept_redirects = 0
•	From Command Line:
o	sed -i '/net.ipv4.conf.all.accept_redirects = 0/anet.ipv4.conf.default.accept_redirects = 0' /etc/sysctl.conf
o	sed -i '/net.ipv6.conf.all.accept_redirects = 0/anet.ipv6.conf.default.accept_redirects = 0' /etc/sysctl.conf


k.	Ignore Directed pings [Not applying this at the moment]
After applying the below, this stops accepting the ping request to it’s public/private IP until server reboot.
To revert the above settings back change that value 0 and sysctl -p
Basically rebooting the VM disables this feature and we will need add the below cron to make it work after reboot:
crontab -e
@reboot echo “1” > /proc/sys/net/ipv4/icmp_echo_ignore_all
Systecmctl start cron.service
Systemctl enable cron.service


Add this line:
•	#Ignore Directed pings
•	net.ipv4.icmp_echo_ignore_all = 1
•	From Command Line:
o	echo -e '#Ignore Directed pings\nnet.ipv4.icmp_echo_ignore_all = 1' >> /etc/sysctl.conf

l.	Block SYN attacks
Add these lines:
•	net.ipv4.tcp_max_syn_backlog = 2048
•	net.ipv4.tcp_synack_retries = 2
•	net.ipv4.tcp_syn_retries = 5
•	From Command Line:
o	sed -i '/net.ipv4.tcp_syncookies=1/anet.ipv4.tcp_max_syn_backlog = 2048' /etc/sysctl.conf
o	sed -i '/net.ipv4.tcp_max_syn_backlog = 2048/anet.ipv4.tcp_synack_retries = 2' /etc/sysctl.conf
o	sed -i '/net.ipv4.tcp_synack_retries = 2/anet.ipv4.tcp_syn_retries = 5' /etc/sysctl.conf

m.	Log Martians
Add this line:
•	net.ipv4.icmp_ignore_bogus_error_responses = 1
•	From Command Line:
o	sed -i '/net.ipv4.conf.all.log_martians = 1/anet.ipv4.icmp_ignore_bogus_error_responses = 1' /etc/sysctl.conf

2.	Refresh sysctl file
•	sysctl -p

Prevent IP Spoofing
1.	Update /etc/host.conf file as below
a.	Block IP Spoofing
•	Replace “order hosts,bind” with “order bind,hosts”
•	Replace “multi on” with “nospoof on”
•	From Command Line:
o	sed -i 's/order hosts,bind/order bind,hosts/g' /etc/host.conf
o	sed -i 's/multi on/nospoof on/g' /etc/host.conf
Firewall
1.	Update current Firewall rules
a.	Open firewall port for SSH from specific subnet
ufw allow from <subnet>  to any port 22
For Test subnet: 10.142.0.0/20
For Production subnet: 10.242.0.0/20
b.	Start the ubuntu firewall: ufw enable
c.	Open firewall ports for services running on this VM from specific subnet. 
Examples:
	ufw allow from 10.142.0.0/20 to any port 3306
	ufw allow https
	ufw allow http

Setup Time and Date for history
1.	Update /etc/profile as below:
a.	Add Time Format for system History command
Add the below line 
•	export HISTTIMEFORMAT="%d/%m/%y %T"
•	From Command Line:
o	echo -e '#History time fromat\nexport HISTTIMEFORMAT="%d/%m/%y %T"' >> /etc/profile
b.	Load the profile change: source /etc/profile
Update Boot File
1.	Update /etc/fstab and replace the below
a.	Replace “LABEL=cloudimg-rootfs   /        ext4   defaults        0 0” with “LABEL=cloudimg-rootfs   /        ext4   defaults        0 1”
b.	From Command Line:
o	sed -i 's/0 0/0 1/g' /etc/fstab
2.	Enable secured shared memory
a.	Update /etc/fstab by adding the below line:
o	echo -e 'tmpfs    /run/shm        tmpfs   defaults,noexec,nosuid 0 0' >> /etc/fstab
Stackdriver-Agent installations for monitoring
1.	Stackdriver-Agent Installations steps:
a.	Download the installer: curl -sSO https://dl.google.com/cloudagents/install-monitoring-agent.sh
b.	Install: Execute: sh install-monitoring-agent.sh
c.	Start Stackdriver-Agent: systemctl start stackdriver-agent
d.	Enable Stackdriver-Agent: systemctl enabled stackdriver-agent
Create separate Cron log
1.	Update /etc/rsyslog.d/50-default.conf as below
a.	Uncomment #cron.* 
b.	Restart ryslog and cron service 
c.	From Command Line:
o	To update /etc/rsyslog.d/50-default.conf: sed -i 's/#cron/cron/g' /etc/rsyslog.d/50-default.conf
o	To restart rsyslog: service rsyslog restart
o	To restart cron: service cron restart
Reboot the server
	1. Reboot the server:
a.	shutdown -r now
		
    
    
    
    
    
